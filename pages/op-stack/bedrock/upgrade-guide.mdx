import { Callout } from 'nextra/components'

# Bedrock Upgrade Guide

OP Mainnet’s migration to Bedrock has concluded and the Bedrock sequencer has started up! Please visit the docs for images and data directories for [node operators](https://community.optimism.io/docs/useful-tools/networks/#parameters-for-node-operators).

<details>
<summary>Full Node Operators</summary>
The migrated (Bedrock) datadir required to spin up op-geth has been successfully hosted and is now [ready for distribution](https://storage.googleapis.com/oplabs-mainnet-data/mainnet-bedrock.tar).
</details>

<details>
<summary>Archival Node Operators</summary>
We have initiated the upload of the archival datadir, which may take up to 24 hours.

While we recommend using the **`legacy-geth`** archival datadir we upload **[once it's ready](https://community.optimism.io/docs/useful-tools/networks/#links)**, given the size of the archival data disk and the time 
it'll take for it to become available we recommend preserving your legacy archival nodes and routing archival traffic to them if possible. To check if your legacy archival node is able to serve traffic, please do the following:

- Verify that the head block number is `105235062`
- Verify that the head block hash is `0x21a168dfa5e727926063a28ba16fd5ee84c814e847c81a699c7a0ea551e4ca50`

If both of these criteria are true, then your legacy archival node is on the same block as the archival datadir and can be used to serve user traffic.

You can set **`--rollup.historicalrpc <l2geth-rpc>`** on **`op-geth`** and it will forward requests for historical data it can't handle to **`l2geth`**.
</details>


## What to Expect

<Callout type="info">
Throughout the migration, the [Optimism Status Page](https://status.optimism.io/) will be updated with the latest migration status and any important information for our partners and node operators.
</Callout>

  | Migration Step | What to Expect |
  | - | - |
  | Initiate migration | Legacy network deposits and withdrawals will be paused. We will wait for the legacy sequencer to finish posting transactions to the L1 chain.
  | Disable Sequencer Ingress | This will happen in tandem with step 1. Transactions on the legacy sequencer will no longer be accepted.
  | Execute L2 Migration | An irregular state transition on L2 will be performed. This is the longest step in the migration process, and could take up to 1.5 hours. It involves running a large script that will migrate ETH balances, migrate withdrawals, and perform migration checks.
  | Build and Push Docker Images | This step will release the op-node image for OP Mainnet in the [OP Mainnet section of the Developer Docs](https://community.optimism.io/docs/useful-tools/networks/#optimism-mainnet) (op-geth image is already available)
  | Host Migrated Datadir | Node operators need two databases to download new network software and spin up Bedrock nodes. After we host the migrated datadir, we will be able to distribute the first database needed: the datadir. 
  | Host Archival Snapshot Database | After we host the archival snapshot database, we will be able to distribute the second database that node operators need to spin up Bedrock nodes: the archival snapshot. Though we will start the process of uploading the archival snapshot earlier in the migration, it can take a long time to upload so we don’t know exactly when this step will be completed. Node operators will also need additional time to download the archival snapshot.
  | Multisig Batch 3: Execute MSD Phase 2 and unpause the portal | This step will upgrade L1 smart contracts. Once the contracts are upgraded, the portal will be unpaused, and deposits/withdrawals will be re-enabled.
  | Enable Sequencer Ingress | At this stage, the Bedrock sequencer will start up, ending the outage portion of the migration.
  | Database Distribution | After the new sequencer is enabled, OP Mainnet’s migration to Bedrock will be complete! We will begin checking in to ensure node operators and other key partners have the databases and support needed to spin up new nodes and resume services. 
  | External OP Mainnet Infrastructure  | Key external OP Mainnet infrastructure will come back online. 

Backwards compatibility is one of the upgrade's key design goals. Potential incompatibilities and their workarounds are highlighted in the sections below.

## Day-of Preparations

- The upgrade to Bedrock is expected to take **between 2-4 hours.** During this time there will be downtime at the chain and infrastructure level while the old sequencer is spun down and the Bedrock sequencer starts up.
- **Transactions, deposits, and withdrawals** **will be unavailable for the duration,** and the chain will not be progressing.
    - Node Operator on OP Mainnet can keep **read access** up ****on their nodes during the migration if they choose.
- Unlike previous upgrades to OP Mainnet, this release will not require a “regenesis,” and historic chain data will still be accessible after the upgrade.

## Developer Guides

If you operate nodes or support apps and wallets that are integrated with OP Mainnet, there may be some actions you need to take to sync your product after the upgrade.

### For Node Operators

**Prerequisites**

This section assumes that you have read and understood our **[Node Operator Guide](https://community.optimism.io/docs/developers/bedrock/node-operator-guide.html)**. Please read that first if you have not already.

From a node operator perspective, the old system will be completely *replaced* on upgrade day. This means that rather than upgrading legacy infrastructure, node operators will be standing up entirely new infrastructure to run the Bedrock network.

On upgrade day, we will provide node operators with the following information in the [OP Mainnet network section](https://community.optimism.io/docs/useful-tools/networks/#optimism-mainnet). To be notified as soon as these are available, watch the [Optimism Status Page](https://status.optimism.io/):

1. The correct `op-node` and `op-geth` images and binaries to use.
2. A URL to an upgraded data directory containing the genesis state for the new system.
3. A URL to a legacy data directory containing data for Legacy Geth, which is needed if you are running an archive node. *Note: We strongly recommend you spin up a fresh legacy geth node with the legacy datadir and do not use existing pre-bedrock archive nodes.*

We will embed the rollup config into the `op-node` itself. Then, on upgrade day, you will need to:

1. Initialize `op-geth`'s data directory using the upgraded genesis state from the provided URL. See the **[Initialization via Data Directory](https://community.optimism.io/docs/developers/bedrock/node-operator-guide.html#initialization-via-data-directory)** section of the Node Operator Guide for more information.
2. Specify the `op-node`'s network via the `-network` flag or `OP_NODE_NETWORK` environment variable. Its value will be `goerli` for the Goerli upgrade, or `mainnet` for the mainnet upgrade.
3. If you are running an archive node, initialize Legacy Geth's data directory using the legacy genesis state from the provided URL. See the **[Initialization via Data Directory](https://community.optimism.io/docs/developers/bedrock/node-operator-guide.html#initialization-via-data-directory)** and **[Legacy Geth](https://community.optimism.io/docs/developers/bedrock/node-operator-guide.html#legacy-geth)** sections of the Node Operator Guide for more information.
4. If you are running an archive node, set the `op-geth` `--rollup.historicalrpc` parameter to point to Legacy Geth's RPC endpoint.
5. Start `op-geth` and `op-node` as usual.

The best way to prepare for the upgrade is to start operating a node on Optimism Goerli.

### For App and Wallet Developers
On upgrade day, deposits and withdrawals will be paused, along with transactions to the sequencer for roughly 2-4 hours. This means that all transactions on OP Mainnet will be halted for the duration of the upgrade. During this time, we recommend you to display a banner to your users with info about the upgrade. 

Once the upgrade is complete, everything should be identical to how it was before the upgrade. All balances, contract addresses, transaction data, block data, and historical execution traces will be preserved. The new network is EVM-equivalent, so all existing Ethereum tooling will continue to work with the new system. Detailed differences are described in **[How is Bedrock Different?](https://community.optimism.io/docs/developers/bedrock/how-is-bedrock-different.html).**

<Callout type="info">
Regular users will not need to take any actions related to the upgrade beyond preparing for 2-4 hours of downtime on upgrade day.
</Callout>

## FAQs

### I’m a node operator. When should I upgrade my node?

The best time to upgrade your node is immediately after OP Mainnet is upgraded to Bedrock. The images we distribute will be nearly up to date, so you'll be able to synchronize relatively quickly. See the ‘For Node Operators’ section above for details [Bedrock Mission Control](#).

### When will the Docker images be published?

They will be published on the day of the upgrade, close to the end of the migration. You will be able to see when they are available [on the status page](https://status.optimism.io/).

### When will the migrated datadir be available?

It will be published on the day of the upgrade, close to the end of the migration. You will be able to see when it is available [on the status page](https://status.optimism.io/).

### When will the Legacy Geth archival datadir be available?

It will also be published on the day of the upgrade, close to the end of the migration. You will be able to see when it is available [on the status page](https://status.optimism.io/).

### Is a rollback possible? What scenarios would trigger one?

There are multiple validity tests planned during the upgrade downtime window (the 2-4 hours starting at 16:00 UTC on June 6th, 2023). In the unlikely case that those tests fail, we would roll back to pre-Bedrock without adding additional downtime.

### How would rolling back to pre-Bedrock affect L2 transactions?

Reverting to pre-Bedrock would not affect L2 transactions. In the unlikely case of requiring reverting to pre-Bedrock, it would happen during the upgrade window before transactions on L2 are re-enabled.

### How is finality calculated in Bedrock?

In Bedrock you determine finality the same way you do in Ethereum.
For example, you can use this command:

```bash
cast block finalized number --rpc-url <https://mainnet.optimism.io>
```

### How long could it take a block to move from latest to finalized?

In theory it could take up to twelve hours. In practice, the sequencer is setup to take 5-10 minutes to write the transactions to L1, and then finalization on L1 can take an additional 15 minutes. 

### How long do deposits take?

After five L1 blocks (1 minute) the chance of a reorg on L1 is negligible, so we accept the deposit on L2. In the unlikely case of a reorg, there could be a reorg of the unsafe portion of the L2 blockchain. Note that blocks that are already either **safe** or **finalized** are not going to be affected by such a reorg.

### What is the new gas limit?

In Bedrock the block gas limit is 30,000,000. Note that we use EIP 1559 for congestion pricing and if a block has more than 5,000,000 gas (target gas limit) the base fee increases (for the L2 execution fee).

### How do I determine the priority fee?

You can see what priority fee was paid by transactions in the last block, as you can do on L1.
You can also use [the gas tracker dashboard](https://optimism.io/gas-tracker).

### How will costs change immediately after the upgrade?

The L1 gas price formula will not be changed, but the we expect to reduce [the dynamic overhead multiplier](https://community.optimism.io/docs/developers/build/transaction-fees/#the-l2-execution-fee) significantly (by ~ 40%) because of the better compression. This is the main cost of Optimism transactions.

The L2 gas price depends on congestion, using the EIP 1559 mechanism. Our gas target is 5,000,000 gas per 2 second block, or 150 million gas per minute. For reference, in L1 Ethereum the gas target is 15 milliom per 12 second block, or 75 million gas per minute.

### ************************What is the date for OP Mainnet’s upgrade to Bedrock?************************

The OP Mainnet upgrade to the Bedrock release will take place on **June 6, 2023 at 16:00 UTC.**

### ************************What block height will the upgrade occur?************************

The upgrade will be triggered at a timestamp, rather than a block number on **June 6, 2023 at 16:00 UTC.**

### **Is this a hard fork, or a new network?**

This is a hard fork. The network will retain the same chain ID, transaction history, and state. The first block of the new network will be the last block of the old network + 1.

### **How long will the upgrade take?**

We expect the upgrade to take between 2-4 hours.

### **How can I see the difference between upstream Geth and op-geth?**

For an overview of changes in `op-geth`, a fork of `go-ethereum`, [check out the diff site](https://op-geth.optimism.io/).

### **Will transaction tracing for post-Bedrock data be faster?**

Yes. `op-geth` uses the latest transaction tracers from upstream, which have much better performance than tracers legacy `l2geth` uses.

### **********************************************************Will withdrawals be affected?**********************************************************

Withdrawals that have not completed their 1 week finalization period or have not been claimed on L1 will have their finalization period reset after the Bedrock upgrade. This means any withdrawals you have not claimed on L1 will require another week of waiting after the Bedrock upgrade completes.

# Upgrade Criteria

In March, Token House delegates voted to approve the Bedrock Upgrade. [In that upgrade proposal](https://gov.optimism.io/t/final-upgrade-proposal-bedrock-v2/5548#internal-rehearsals-11), we committed to meeting several criteria before upgrading OP Mainnet to Bedrock. 

**These criteria are:**

- A successful upgrade of OP Goerli to the “Regolith” release, which incorporates improvements identified in the first Sherlock audit. 
- A follow-up Sherlock audit to test the fixes made in “Regolith.”
- 2 internal rehearsals of the migration and 1 rehearsal of recovery from the unexpected event of a faulty proposal
- 2 weeks of testnet stability on a consensus + feature frozen release.
- Public announcement of OP Mainnet Upgrade date, delivered with 3 weeks notice.

## Update Log

This section logs relevant updates about our progress towards upgrading OP Mainnet to Bedrock.

| March 24 | Sherlock Audit Competition #2 begins. | We kicked off our second audit competition with Sherlock. It ran for a total of 3 weeks: 2 weeks for the competition, and 1 week of judging. |
| --- | --- | --- |
| April 3 | Consensus + Feature Freeze | We pushed fixes from the results of the first Sherlock audit competition, which concluded in March. We https://twitter.com/OPLabsPBC/status/1643344162165514244 status. |
| April 12 | Sherlock Audit Competition #2 concludes. | After reviewing the findings from the second audit competition we determined that there are medium severity findings that we need to fix, which will break the Consensus & Feature Freeze |
| April 27 | Re-hit Consensus and Feature Freeze | We implemented fixes for the issues identified in the second audit competition. We re-deployed our contracts to OP Goerli and hit Consensus + Feature Frozen status again. |
| May 11 | 2 weeks of stability  | We reached 2 weeks of stability on OP Goerli on May 11.  |
| May 12 | Internal rehearsals of migration | We actively rehearsed the migration of OP Mainnet to OP Bedrock to ensure a smooth, fast, secure upgrade. We have completed 3/3 full rehearsals. |
| May 15 | Preparing for announcement | We are getting ready to share the official date for OP Mainnet’s upgrade to Bedrock, including some final quality control checks.  |
| May 15 | Upgrade date announced. | On May 15, we announced the official date for OP Mainnet’s upgrade to Bedrock: June 6, 2023 at 16:00 UTC. |

## A Note on Timing

The Bedrock release is a complete re-write of an entire rollup stack, and will be **the largest upgrade** ever released on OP Mainnet. 
We established the above criteria in collaboration with Optimism Foundation and the Token House to maintain accountability and ensure 
Bedrock achieves the highest standard of security and stability prior to announcing the upgrade date. 